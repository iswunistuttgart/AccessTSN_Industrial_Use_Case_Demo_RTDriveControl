# AccessTSN Industrial Use Case Demo - RTDriveControl: Documentation of real time communication setup and frame format
## Communication scheme
The two application of this RTDriveControl project (the tsnsender and the tsndrive) communicate with each other in real time using a TSN network. The tsnsender application sends set-point velocity values (and some control values) to the tsndrive application. The tsndrive application sends current position and drive fault values to the tsnsender application. Each application is sending periodically. Both application act independently in regards to the data transmission, they do not work in an request/response principle. The timing of the transmission can be configured according to the TSN network schedule. While the tsnsender application send a single transmission with the values for all axes, the tsndrive application does separated transmission for each axis. This way the different axes (Axis X,Y,Z and spindle) can be executed and computed on different hardware to make the demo setup bigger.

## Data Messages 
The realtime communication uses OPC UA Pub/Sub Messages over Ethernet (Layer 2). This way the IP/UDP-network stacks are not used and with that the latency is reduced. The used OPC UA Pub/Sub Messages are of the _DateSetMessage_ type. The complete OPC UA Pub/Sub Message, Ethernet Frame, which fields are used and how the messages are configures is explained below.

## Implementation details
For the creation and parsing of the OPC UA Pub/Sub Message no framework is used, everything is implemented by the applications to have maximum control over the messages and as an example how a custom message frame could be implemented. The implementation tries to mimic the Linux socket buffer structure with a common buffer and multiple pointers. The goal of this design is to have as few as possible memory copy operations.

To time the transmission correctly the applications use the Time Triggered Send feature (ETF) though the _SO_TXTIME_ option of the Linux sockets. For reduced latency and more control over the network stack the applications use an _AF_PACKET_ socket and build and parse the packets themselves. In the future the eXpress Data Path (XDP) feature should be used on RX.

While the OPC UA specification allows multiple OPC UA Pub/Sub messages which might not be of the same type in a single packet, this is not represented and used in the current implementation. While the functions to setup (*packet_handler.c/setpkt*) and parse (*packet_handler.c/prspkt*) can handle multiple messages of the same type in a packet the functions filling a the messages into a packet only support a single message per packet. Packets with multiple types of messages are not supported by any function. 

## Message and Frame Format
For destination addresses, Layer2-Multicast-addresses are used. These can be specified in the source code.

Basically there are two types of packets communicated: one for control information (information generated by the control e.g. set-point values)and one for the information of a single axis (information generated by an axis e.g. current values). Both types are mostly identical for their frame format and only differ in the message payload. When sending the frame is created starting from the network message header, the creation of the Ethernet header is delegated to the network stack. When receiving, the complete frame including Ethernet header is received by the application. Therefore the packet parser needs to take care of that.

### Communicated Frame with OPC UA headers but without message payload
Table 1 shows the format of a frame without the message payload. The size, either the fixed or a example value are given. Frame is described from the application point of view. Generally values are given in host (x64) byte order and must be converted to and from network byte order if not noted otherwise.

| Position TX (Byte)| Position RX (Byte) | Field group |  Field name | Size | Description | Type | Fixed Value | Example value | Note |
| ----------- | ----------- | ---------- | ----------- |---- | ----------- | ---- | ----------- | ------------- | ---- |
| NA          | 0 - 5       | Ethernet Header| Destination MAC | 6 Byte | MAC Address of the destination | 6 chars | NA | 01:AC:CE:55:00:00 | In the demo these are multicast addresses |
| NA          | 6 - 11      | Ethernet Header| Source MAC      | 6 Byte | MAC Address of the source      | 6 chars | NA | 00:11:22:33:44:55 | Address of used hardware |
| NA          | 12 - 13      | Ethernet Header| Ethertype       | 2 Byte | Ethertype for UPC UA Layer 2   | uint16  | 0xB62C | NA |  |
| 0 | 14 | Network Message Header| Version / Flags | 1 Byte | Version and Flags of UADP Network message | uint8 | 0xF1 | NA | Version = 1; PublishID, GroupHeader, PayloadHdr and ExtendedFlags 1 enabled |
| 1 | 15 | Network Message Header| Extended Flags 1 Â» 1 Byte | Extended Flags of UADP Network message | uint8 | 0x21 | NA | PubishID datatype =  Uint16; Timestamp enabled |
| 2 - 3 | 16 - 17 | Network Message Header| Publisher ID | 2 Byte | Pubisher ID or Talker ID | uint16 | NA | 0xAC00 | Can be specified on through command line argument|
| 4 | 18 | Group Header| Group Flags | 1 Byte | Flags of Group Header | uint8 | 0x0B| NA | WritergroupID, GroupVersion and Sequencenumber enabled |
| 5 - 6 | 19 - 20 | Group Header | Writer Group ID | 2 Byte | ID of Writer Group | uint16 | NA | 0x1000 | Specified as #define in *packet handler.h* |
| 7 - 10 | 21 - 24 | Group Header| Group Version | 4 Byte | Group Version | uint32 | NA | 0x26DEFA00 | Seconds since Jan 1st, 2000; Created on sept 1st. 2020; Specified as #define in *packet handler.h* |
| 11 -12 | 25 -26 | Group Header| SeqNo | 2 byte | Sequence number | uint16 | NA | 0 | Counter with is increased for each successfully send packet |
| 13 | 27 | Payload Header | Message Count | 1 Byte | Number of messages in this packet | uint8 | 1 | NA | Currently fixed for this implementation |
| 14 - 15 | 28 - 29 | Payload Header | WriterID | 2 Byte | DatasetwriterID | uint16 | NA | 0xAC00 | In specification: Array of multiple datasetwriterids, one for each message; In Implementation: only single message per packet supported; Different value specified as #define in *packet handler.h* for control and each axis message|
| 16 - 23 | 30 -37 | Extended Network Header | Timestamp | 8 Byte | Message Creation Timestamp;  OPC UA Timestamp | uint64 | NA | NA | Currently no conversion to Network Byte Order applied|
| 24 - [...] | 38 - [...]] | DataSet message | Dataset message | min 25 Byte | Dataset message, see table 2 and 3 for structure of used dataset messages | NA | NA | NA | In specification: An Array with the sizes of the dataset messages is specified at this position, but if packet only has a single message this size array is omitted. Since this implementation only supports a single message per packet, the size array is ommitted. |

Table 1: Frame format of used UADP Message over Layer 2 Ethernet Frames

### Control Information Message
Table 2 shows the format of a control information message. This user specified message format is used to transmit the control information from the CNC machine control to the drives. Frame is described from the application point of view. Generally values are given in host (x64) byte order and must be converted to and from network byte order if not noted otherwise. The position value is restarted at zero and is identical for RX and TX.

Position (Byte) |  Field name | Size | Description | Type | Fixed Value | Example value | Note |
| ----------- |  ----------- |---- | ----------- | ---- | ----------- | ------------- | ---- |
| 0|  DataSet message Header | 1 Byte | Header of DataSet message with flags | uint8 | 0x01 | NA | Set to valid |
| 1 - 2 | DataSet message FiledCount | 2 Byte | Number of field in DataSet message | uint16 |11 | NA | Control Information message has 11 fields. |
| 3 - 10 | X Velocity | 8 Byte | Velocity Set point value for X axis | int64| NA | | Double encoded as Int64 (nano units)| 
| 11 - 18 | Y Velocity | 8 Byte | Velocity Set point value for Y axis | int64| NA | | Double encoded as Int64 (nano units)| 
| 19 - 26 | Z Velocity | 8 Byte | Velocity Set point value for Z axis | int64| NA | | Double encoded as Int64 (nano units)| 
| 27 - 34 | Spindlespeed | 8 Byte | Set point value for speed of spindle | int64| NA | | Double encoded as Int64 (nano units)| 
| 35 | X Enable | 1 Byte | Enable flag for X axis | int8 | NA | | Enabled if > 0|
| 36 | Y Enable | 1 Byte | Enable flag for Y axis | int8 | NA | | Enabled if > 0|
| 37 | Z Enable | 1 Byte | Enable flag for Z axis | int8 | NA | | Enabled if > 0|
| 38 | Spindle Enable | 1 Byte | Enable flag for spindle | int8 | NA | | Enabled if > 0|
| 39 | Spindlebreak Enable | 1 Byte | Enable flag for Spindle break | int8 | NA | | Enabled if > 0|
| 40 | Machinestatus | 1 Byte | Status flag for status of machine | int8 | NA | | Machine on if > 0|
| 41 | EStopstatus | 1 Byte | Status flag for Emergency Stop | int8 | NA | | Emergency Stop engaged if > 0|

Table 2: Frame Format for User defines control information message

### Axis Information Message
Table 3 shows the format of a axis information message. This user specified message format is used to transmit the axis information from the drives to the CNC machine control. Frame is described from the application point of view. Generally values are given in host (x64) byte order and must be converted to and from network byte order if not noted otherwise. The position value is restarted at zero and is identical for RX and TX. In the payload of the DataSet message the axis for which the information is valid is not specified directly, this information is can be derived from the Writer ID in the payload header.

Position (Byte) |  Field name | Size | Description | Type | Fixed Value | Example value | Note |
| ----------- |  ----------- |---- | ----------- | ---- | ----------- | ------------- | ---- |
| 0|  DataSet message Header | 1 Byte | Header of DataSet message with flags | uint8 | 0x01 | NA | Set to valid |
| 1 - 2 | DataSet message FiledCount | 2 Byte | Number of field in DataSet message | uint16 | 2 | NA | Axis Information message has 2 fields. |
| 3 - 10 | Current Position | 8 Byte | Current position on this axis | int64| NA | | Double encoded as Int64 (nano units)| 
| 11 | Fault | 1 Byte | Status flag for faults | int8 | NA | | Fault occurred  if > 0|
[12 - 34] | Padding | 22 Byte | Padding to reach minimum Ethernet frame length | uin8[]| 0000 | NA | |

Table 3: Frame Format for User defines axis information message
